! This program is a part of EASIFEM library
! Copyright (C) 2020-2021  Vikas Sharma, Ph.D
!
! This program is free software: you can redistribute it and/or modify
! it under the terms of the GNU General Public License as published by
! the Free Software Foundation, either version 3 of the License, or
! (at your option) any later version.
!
! This program is distributed in the hope that it will be useful,
! but WITHOUT ANY WARRANTY; without even the implied warranty of
! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
! GNU General Public License for more details.
!
! You should have received a copy of the GNU General Public License
! along with this program.  If not, see <https: //www.gnu.org/licenses/>
!

!> authors: Vikas Sharma, Ph. D.
! date: 1 March 2021
! summary: Module for Lagrange element

SUBMODULE( ReferenceElement_Method ) Lagrange
USE BaseMethod
IMPLICIT NONE
CONTAINS

!----------------------------------------------------------------------------
!                                                              LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Line
  ! Define internal variables
  INTEGER( I4B ) :: i
  REAL( DFP ) :: x(2)
  ALLOCATE( NodeCoord( 3, Order+1 ) )

  SELECT CASE( Order )
    CASE( 1 )
    NodeCoord = RESHAPE( [&
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1] )

    CASE( 2 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP ], [3, Order+1] )

    CASE( 3 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP ], [3, Order+1])

    CASE( 4 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.5_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1])

    CASE( 5 )
    NodeCoord = RESHAPE( [ &
      & -1.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & -0.6, 0.0, 0.0, &
      & -0.2, 0.0, 0.0, &
      & 0.2, 0.0, 0.0, &
      & 0.6, 0.0, 0.0 ], [3, Order + 1])

    CASE( 6 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.66666666666666666667_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.66666666666666666667_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1])

    CASE( 7 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.71428571428571428571_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.42857142857142857143_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.14285714285714285714_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.14285714285714285714_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.42857142857142857143_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.71428571428571428571_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1])

    CASE( 8 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.75_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.5_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.25_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.25_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.75_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1])

    CASE( 9 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.77777777777777777778_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.55555555555555555556_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.11111111111111111111_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.11111111111111111111_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.55555555555555555556_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.77777777777777777778_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1])

    CASE( 10 )
    NodeCoord = RESHAPE( [ &
      & -1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.8_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.6_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.4_DFP, 0.0_DFP, 0.0_DFP, &
      & -0.2_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.2_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.4_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.6_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.8_DFP, 0.0_DFP, 0.0_DFP ], [3, Order + 1])

    CASE DEFAULT

    NodeCoord = 0.0_DFP
    NodeCoord( 1, 1 ) = -1.0_DFP
    NodeCoord( 1, 2 ) = 1.0_DFP
    DO i = 3, Order + 1
      NodeCoord( 1, i ) = ( 2.0_DFP * REAL( i, DFP ) &
        & - REAL( Order, DFP )  - 4.0_DFP ) / ( REAL( Order, DFP )  )
    END DO

  END SELECT

  x = RefElem % XiJ( 1, 1:2 )

  NodeCoord( 1, : ) = 0.5_DFP * ( x( 1 ) + x( 2 ) ) &
    & +  0.5_DFP * ( x( 2 ) - x( 1 ) ) * NodeCoord( 1, : )


END PROCEDURE EquidistanceLIP_Line

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Line
  INTEGER( I4B ) :: nns, i

  Obj % XiJ = LagrangePoints( RefElem, Order )
  nns = SIZE( Obj % XiJ, 2 )

  Obj % EntityCounts = [nns, 1, 0, 0]
  Obj % XiDimension = 1
  Obj % Order = Order
  Obj % NSD = RefElem % NSD
  Obj % Name = ElementType( "Line" // TRIM( INT2STR( nns ) ) )
  ALLOCATE( Obj % Topology( nns + 1 ) )

  DO i = 1, nns
    Obj % Topology( i ) = ReferenceTopology( [i], Point )
  END DO

  Obj % Topology( nns + 1 ) = ReferenceTopology( [(i, i=1,nns)], Obj % Name )

END PROCEDURE LagrangeElement_Line

!----------------------------------------------------------------------------
!                                                            LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Triangle
  ! Define internal variables
  INTEGER( I4B ) :: i
  REAL( DFP ) :: x( 3 ), y( 3 )
  REAL( DFP ), ALLOCATABLE :: Xi( : ), Eta( : )

  SELECT CASE( Order )
    CASE( 1 )
    ! order 1; Triangle3
    NodeCoord = RESHAPE( [ &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 1.0_DFP, 0.0_DFP], [3, 3] )

    CASE( 2 )
    ! order 2, Triangle6
    NodeCoord = RESHAPE( [ &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 1.0_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.5_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.5_DFP, 0.0_DFP ], [3, 6])

    CASE( 3 )
    ! order 3, Triangle10
    NodeCoord = RESHAPE( [ &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 1.0_DFP, 0.0_DFP, &
      & 0.33333333333333333333_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.66666666666666666667_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.66666666666666666667_DFP, 0.33333333333333333333_DFP, 0.0_DFP, &
      & 0.33333333333333333333_DFP, 0.66666666666666666667_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.66666666666666666667_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.33333333333333333333_DFP, 0.0_DFP, &
      & 0.33333333333333333333_DFP, 0.33333333333333333333_DFP, 0.0_DFP], [3, 10])

    CASE( 4 )
    ! order 4 Includes bubble nodes also
    ! Trianagle15a
    NodeCoord = RESHAPE( [ &
      & 0.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 1.0_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.0_DFP, 1.0_DFP, 0.0_DFP, &
      & 0.25_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.75_DFP, 0.0_DFP, 0.0_DFP, &
      & 0.75_DFP, 0.25_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.5_DFP, 0.0_DFP, &
      & 0.25_DFP, 0.75_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.75_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.5_DFP, 0.0_DFP, &
      & 0.0_DFP, 0.25_DFP, 0.0_DFP, &
      & 0.25_DFP, 0.25_DFP, 0.0_DFP, &
      & 0.5_DFP, 0.25_DFP, 0.0_DFP, &
      & 0.25_DFP, 0.5_DFP, 0.0_DFP], [3, 15])

    CASE( 5 )
    ! This is fifth order triangle
    ! 3 nodes on vertex, 12 nodes on edge, and 6 on the face
    ! Triangle21
      NodeCoord = RESHAPE( [ &
        & 0.0, 0.0, 0.0, &
        & 1.0, 0.0, 0.0, &
        & 0.0, 1.0, 0.0, &
        & 0.2, 0.0, 0.0, &
        & 0.4, 0.0, 0.0, &
        & 0.6, 0.0, 0.0, &
        & 0.8, 0.0, 0.0, &
        & 0.8, 0.2, 0.0, &
        & 0.6, 0.4, 0.0, &
        & 0.4, 0.6, 0.0, &
        & 0.2, 0.8, 0.0, &
        & 0.0, 0.8, 0.0, &
        & 0.0, 0.6, 0.0, &
        & 0.0, 0.4, 0.0, &
        & 0.0, 0.2, 0.0, &
        & 0.2, 0.2, 0.0, &
        & 0.6, 0.2, 0.0, &
        & 0.2, 0.6, 0.0, &
        & 0.4, 0.2, 0.0, &
        & 0.4, 0.4, 0.0, &
        & 0.2, 0.4, 0.0], [3, 21])

    CASE( 6 )
    ! Triangle28
    NodeCoord = RESHAPE( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.16666666666666666667, 0.0, 0.0, &
      & 0.33333333333333333333, 0.0, 0.0, &
      & 0.5, 0.0, 0.0, &
      & 0.66666666666666666667, 0.0, 0.0, &
      & 0.83333333333333333333, 0.0, 0.0, &
      & 0.83333333333333333333, 0.16666666666666666667, 0.0, &
      & 0.66666666666666666667, 0.33333333333333333333, 0.0, &
      & 0.5, 0.5, 0.0, &
      & 0.33333333333333333333, 0.66666666666666666667, 0.0, &
      & 0.16666666666666666667, 0.83333333333333333333, 0.0, &
      & 0.0, 0.83333333333333333333, 0.0, &
      & 0.0, 0.66666666666666666667, 0.0, &
      & 0.0, 0.5, 0.0, &
      & 0.0, 0.33333333333333333333, 0.0, &
      & 0.0, 0.16666666666666666667, 0.0, &
      & 0.16666666666666666667, 0.16666666666666666667, 0.0, &
      & 0.66666666666666666667, 0.16666666666666666667, 0.0, &
      & 0.16666666666666666667, 0.66666666666666666667, 0.0, &
      & 0.33333333333333333333, 0.16666666666666666667, 0.0, &
      & 0.5, 0.16666666666666666667, 0.0, &
      & 0.5, 0.33333333333333333333, 0.0, &
      & 0.33333333333333333333, 0.5, 0.0, &
      & 0.16666666666666666667, 0.5, 0.0, &
      & 0.16666666666666666667, 0.33333333333333333333, 0.0, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.0], [3, 28] )

    CASE( 7 )
    NodeCoord = RESHAPE( [ &
      &	0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.14285714285714285714, 0.0, 0.0, &
      & 0.28571428571428571429, 0.0, 0.0, &
      & 0.42857142857142857143, 0.0, 0.0, &
      & 0.57142857142857142857, 0.0, 0.0, &
      & 0.71428571428571428571, 0.0, 0.0, &
      & 0.85714285714285714286, 0.0, 0.0, &
      & 0.85714285714285714286, 0.14285714285714285714, 0.0, &
      & 0.71428571428571428571, 0.28571428571428571429, 0.0, &
      & 0.57142857142857142857, 0.42857142857142857143, 0.0, &
      & 0.42857142857142857143, 0.57142857142857142857, 0.0, &
      & 0.28571428571428571429, 0.71428571428571428571, 0.0, &
      & 0.14285714285714285714, 0.85714285714285714286, 0.0, &
      & 0.0, 0.85714285714285714286, 0.0, &
      & 0.0, 0.71428571428571428571, 0.0, &
      & 0.0, 0.57142857142857142857, 0.0, &
      & 0.0, 0.42857142857142857143, 0.0, &
      & 0.0, 0.28571428571428571429, 0.0, &
      & 0.0, 0.14285714285714285714, 0.0, &
      & 0.14285714285714285714, 0.14285714285714285714, 0.0, &
      & 0.71428571428571428571, 0.14285714285714285714, 0.0, &
      & 0.14285714285714285714, 0.71428571428571428571, 0.0, &
      & 0.28571428571428571429, 0.14285714285714285714, 0.0, &
      & 0.42857142857142857143, 0.14285714285714285714, 0.0, &
      & 0.57142857142857142857, 0.14285714285714285714, 0.0, &
      & 0.57142857142857142857, 0.28571428571428571429, 0.0, &
      & 0.42857142857142857143, 0.42857142857142857143, 0.0, &
      & 0.28571428571428571429, 0.57142857142857142857, 0.0, &
      & 0.14285714285714285714, 0.57142857142857142857, 0.0, &
      & 0.14285714285714285714, 0.42857142857142857143, 0.0, &
      & 0.14285714285714285714, 0.28571428571428571429, 0.0, &
      & 0.28571428571428571429, 0.28571428571428571429, 0.0, &
      & 0.42857142857142857143, 0.28571428571428571429, 0.0, &
      & 0.28571428571428571429, 0.42857142857142857143, 0.0 ], [3,36])

    CASE( 8 )
    NodeCoord = RESHAPE( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.125, 0.0, 0.0, &
      & 0.25, 0.0, 0.0, &
      & 0.375, 0.0, 0.0, &
      & 0.5, 0.0, 0.0, &
      & 0.625, 0.0, 0.0, &
      & 0.75, 0.0, 0.0, &
      & 0.875, 0.0, 0.0, &
      & 0.875, 0.125, 0.0, &
      & 0.75, 0.25, 0.0, &
      & 0.625, 0.375, 0.0, &
      & 0.5, 0.5, 0.0, &
      & 0.375, 0.625, 0.0, &
      & 0.25, 0.75, 0.0, &
      & 0.125, 0.875, 0.0, &
      & 0.0, 0.875, 0.0, &
      & 0.0, 0.75, 0.0, &
      & 0.0, 0.625, 0.0, &
      & 0.0, 0.5, 0.0, &
      & 0.0, 0.375, 0.0, &
      & 0.0, 0.25, 0.0, &
      & 0.0, 0.125, 0.0, &
      & 0.125, 0.125, 0.0, &
      & 0.75, 0.125, 0.0, &
      & 0.125, 0.75, 0.0, &
      & 0.25, 0.125, 0.0, &
      & 0.375, 0.125, 0.0, &
      & 0.5, 0.125, 0.0, &
      & 0.625, 0.125, 0.0, &
      & 0.625, 0.25, 0.0, &
      & 0.5, 0.375, 0.0, &
      & 0.375, 0.5, 0.0, &
      & 0.25, 0.625, 0.0, &
      & 0.125, 0.625, 0.0, &
      & 0.125, 0.5, 0.0, &
      & 0.125, 0.375, 0.0, &
      & 0.125, 0.25, 0.0, &
      & 0.25, 0.25, 0.0, &
      & 0.5, 0.25, 0.0, &
      & 0.25, 0.5, 0.0, &
      & 0.375, 0.25, 0.0, &
      & 0.375, 0.375, 0.0, &
      & 0.25, 0.375, 0.0 ], [3, 45])

    CASE( 9 )
    NodeCoord = RESHAPE( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.11111111111111111111, 0.0, 0.0, &
      & 0.22222222222222222222, 0.0, 0.0, &
      & 0.33333333333333333333, 0.0, 0.0, &
      & 0.44444444444444444444, 0.0, 0.0, &
      & 0.55555555555555555556, 0.0, 0.0, &
      & 0.66666666666666666667, 0.0, 0.0, &
      & 0.77777777777777777778, 0.0, 0.0, &
      & 0.88888888888888888889, 0.0, 0.0, &
      & 0.88888888888888888889, 0.11111111111111111111, 0.0, &
      & 0.77777777777777777778, 0.22222222222222222222, 0.0, &
      & 0.66666666666666666667, 0.33333333333333333333, 0.0, &
      & 0.55555555555555555556, 0.44444444444444444444, 0.0, &
      & 0.44444444444444444444, 0.55555555555555555556, 0.0, &
      & 0.33333333333333333333, 0.66666666666666666667, 0.0, &
      & 0.22222222222222222222, 0.77777777777777777778, 0.0, &
      & 0.11111111111111111111, 0.88888888888888888889, 0.0, &
      & 0.0, 0.88888888888888888889, 0.0, &
      & 0.0, 0.77777777777777777778, 0.0, &
      & 0.0, 0.66666666666666666667, 0.0, &
      & 0.0, 0.55555555555555555556, 0.0, &
      & 0.0, 0.44444444444444444444, 0.0, &
      & 0.0, 0.33333333333333333333, 0.0, &
      & 0.0, 0.22222222222222222222, 0.0, &
      & 0.0, 0.11111111111111111111, 0.0, &
      & 0.11111111111111111111, 0.11111111111111111111, 0.0, &
      & 0.77777777777777777778, 0.11111111111111111111, 0.0, &
      & 0.11111111111111111111, 0.77777777777777777778, 0.0, &
      & 0.22222222222222222222, 0.11111111111111111111, 0.0, &
      & 0.33333333333333333333, 0.11111111111111111111, 0.0, &
      & 0.44444444444444444444, 0.11111111111111111111, 0.0, &
      & 0.55555555555555555556, 0.11111111111111111111, 0.0, &
      & 0.66666666666666666667, 0.11111111111111111111, 0.0, &
      & 0.66666666666666666667, 0.22222222222222222222, 0.0, &
      & 0.55555555555555555556, 0.33333333333333333333, 0.0, &
      & 0.44444444444444444444, 0.44444444444444444444, 0.0, &
      & 0.33333333333333333333, 0.55555555555555555556, 0.0, &
      & 0.22222222222222222222, 0.66666666666666666667, 0.0, &
      & 0.11111111111111111111, 0.66666666666666666667, 0.0, &
      & 0.11111111111111111111, 0.55555555555555555556, 0.0, &
      & 0.11111111111111111111, 0.44444444444444444444, 0.0, &
      & 0.11111111111111111111, 0.33333333333333333333, 0.0, &
      & 0.11111111111111111111, 0.22222222222222222222, 0.0, &
      & 0.22222222222222222222, 0.22222222222222222222, 0.0, &
      & 0.55555555555555555556, 0.22222222222222222222, 0.0, &
      & 0.22222222222222222222, 0.55555555555555555556, 0.0, &
      & 0.33333333333333333333, 0.22222222222222222222, 0.0, &
      & 0.44444444444444444444, 0.22222222222222222222, 0.0, &
      & 0.44444444444444444444, 0.33333333333333333333, 0.0, &
      & 0.33333333333333333333, 0.44444444444444444444, 0.0, &
      & 0.22222222222222222222, 0.44444444444444444444, 0.0, &
      & 0.22222222222222222222, 0.33333333333333333333, 0.0, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.0 ], [3,55] )

    CASE( 10 )
    NodeCoord = RESHAPE( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.1, 0.0, 0.0, &
      & 0.2, 0.0, 0.0, &
      & 0.3, 0.0, 0.0, &
      & 0.4, 0.0, 0.0, &
      & 0.5, 0.0, 0.0, &
      & 0.6, 0.0, 0.0, &
      & 0.7, 0.0, 0.0, &
      & 0.8, 0.0, 0.0, &
      & 0.9, 0.0, 0.0, &
      & 0.9, 0.1, 0.0, &
      & 0.8, 0.2, 0.0, &
      & 0.7, 0.3, 0.0, &
      & 0.6, 0.4, 0.0, &
      & 0.5, 0.5, 0.0, &
      & 0.4, 0.6, 0.0, &
      & 0.3, 0.7, 0.0, &
      & 0.2, 0.8, 0.0, &
      & 0.1, 0.9, 0.0, &
      & 0.0, 0.9, 0.0, &
      & 0.0, 0.8, 0.0, &
      & 0.0, 0.7, 0.0, &
      & 0.0, 0.6, 0.0, &
      & 0.0, 0.5, 0.0, &
      & 0.0, 0.4, 0.0, &
      & 0.0, 0.3, 0.0, &
      & 0.0, 0.2, 0.0, &
      & 0.0, 0.1, 0.0, &
      & 0.1, 0.1, 0.0, &
      & 0.8, 0.1, 0.0, &
      & 0.1, 0.8, 0.0, &
      & 0.2, 0.1, 0.0, &
      & 0.3, 0.1, 0.0, &
      & 0.4, 0.1, 0.0, &
      & 0.5, 0.1, 0.0, &
      & 0.6, 0.1, 0.0, &
      & 0.7, 0.1, 0.0, &
      & 0.7, 0.2, 0.0, &
      & 0.6, 0.3, 0.0, &
      & 0.5, 0.4, 0.0, &
      & 0.4, 0.5, 0.0, &
      & 0.3, 0.6, 0.0, &
      & 0.2, 0.7, 0.0, &
      & 0.1, 0.7, 0.0, &
      & 0.1, 0.6, 0.0, &
      & 0.1, 0.5, 0.0, &
      & 0.1, 0.4, 0.0, &
      & 0.1, 0.3, 0.0, &
      & 0.1, 0.2, 0.0, &
      & 0.2, 0.2, 0.0, &
      & 0.6, 0.2, 0.0, &
      & 0.2, 0.6, 0.0, &
      & 0.3, 0.2, 0.0, &
      & 0.4, 0.2, 0.0, &
      & 0.5, 0.2, 0.0, &
      & 0.5, 0.3, 0.0, &
      & 0.4, 0.4, 0.0, &
      & 0.3, 0.5, 0.0, &
      & 0.2, 0.5, 0.0, &
      & 0.2, 0.4, 0.0, &
      & 0.2, 0.3, 0.0, &
      & 0.3, 0.3, 0.0, &
      & 0.4, 0.3, 0.0, &
      & 0.3, 0.4, 0.0 ], [3,66] )
  END SELECT

  x = RefElem % XiJ( 1, 1:3 )
  y = RefElem % XiJ( 2, 1:3 )
  Xi = NodeCoord( 1, : )
  Eta = NodeCoord( 2, : )

  NodeCoord( 1, : ) = x( 1 ) + ( x( 2 ) - x( 1 ) ) * Xi &
    + ( x( 3 ) - x( 1 ) ) * Eta

  NodeCoord( 2, : ) = y( 1 ) + ( y( 2 ) - y( 1 ) ) * Xi &
    + ( y( 3 ) - y( 1 ) ) * Eta

  DEALLOCATE( Xi, Eta )

END PROCEDURE EquidistanceLIP_Triangle

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Triangle

  INTEGER( I4B ) :: I, NNS, NSD

  Obj % XiJ = LagrangePoints( RefElem, Order )
  NSD = RefElem % NSD

  SELECT CASE( Order )
  CASE( 1 )
    NNS = 3
    Obj % EntityCounts = [NNS, 3, 1, 0]
    Obj % XiDimension = 2
    Obj % Name = Triangle3
    Obj % Order = 1
    Obj % NSD = NSD
    ALLOCATE( Obj % Topology( SUM( Obj % EntityCounts) ) )

    DO I = 1, NNS
      Obj % Topology( I ) = ReferenceTopology( [I], Point )
    END DO

    Obj % Topology( NNS + 1 ) = ReferenceTopology( [1, 2], Line2 )
    Obj % Topology( NNS + 2 ) = ReferenceTopology( [2, 3], Line2 )
    Obj % Topology( NNS + 3 ) = ReferenceTopology( [3, 1], Line2 )
    Obj % Topology( NNS + 4 ) = ReferenceTopology( [1, 2, 3], Obj % Name )

  CASE( 2 )
    NNS = 6
    Obj % EntityCounts = [NNS, 3, 1, 0]
    Obj % XiDimension = 2
    Obj % Name = Triangle6
    Obj % Order = 2
    Obj % NSD = NSD
    ALLOCATE( Obj % Topology( SUM( Obj % EntityCounts) ) )

    DO I = 1, NNS
      Obj % Topology( I ) = ReferenceTopology( [I], Point )
    END DO

    Obj % Topology( NNS + 1 ) = ReferenceTopology( [1, 2, 4], Line3 )
    Obj % Topology( NNS + 2 ) = ReferenceTopology( [2, 3, 5], Line3 )
    Obj % Topology( NNS + 3 ) = ReferenceTopology( [3, 1, 6], Line3 )
    Obj % Topology( NNS + 4 ) = ReferenceTopology( [1, 2, 3, 4, 5, 6], Obj % Name )

  CASE( 3 )
    NNS = 10
    Obj % EntityCounts = [NNS, 3, 1, 0]
    Obj % XiDimension = 2
    Obj % Name = Triangle10
    Obj % Order = 3
    Obj % NSD = NSD
    ALLOCATE( Obj % Topology( SUM( Obj % EntityCounts) ) )

    DO I = 1, NNS
      Obj % Topology( I ) = ReferenceTopology( [I], Point )
    END DO

    Obj % Topology( NNS + 1 ) = ReferenceTopology( [1, 2, 4, 5], Line4 )
    Obj % Topology( NNS + 2 ) = ReferenceTopology( [2, 3, 6, 7], Line4 )
    Obj % Topology( NNS + 3 ) = ReferenceTopology( [3, 1, 8, 9], Line4 )
    Obj % Topology( NNS + 4 ) = ReferenceTopology( &
      & [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], Obj % Name )
  END SELECT

END PROCEDURE LagrangeElement_Triangle

!----------------------------------------------------------------------------
!                                                            LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Quadrangle

  TYPE( ReferenceLine_ ) :: RefLine
  INTEGER( I4B ) :: n, i, j
  REAL( DFP ), ALLOCATABLE :: Pt( :, : ), Nodes( :, : )
  INTEGER( I4B ), ALLOCATABLE :: Map( : )

  RefLine = ReferenceLine(NSD = 1)
  Pt = EquidistanceLIP_Line( RefLine, Order )

  Pt( 2, : ) = Pt( 1, : )
  Pt( 1, 2:Order ) = Pt( 2, 3:)
  Pt( 1, Order + 1 ) = Pt( 2, 2 )
  Pt( 2, : ) = 0

  n = ( Order + 1 ) ** 2
  ALLOCATE( Nodes( 3, n ), Map( n ), NodeCoord( 3, n ) )

  n = 0
  DO j = 1, Order + 1
    DO i = 1, Order + 1
      n = n + 1
      Nodes( 1, n ) = Pt( 1, i )
      Nodes( 2, n ) = Pt( 1, j )
      Nodes( 3, n ) = 0.0_DFP
    END DO
  END DO

  SELECT CASE( Order )
  CASE( 1 )
    Map = [1,2,4,3]
  CASE( 2 )
    Map = [1,3,9,7,2,6,8,4,5]
  CASE( 3 )
    Map = [ 1, 4, 16, 13, &
          & 2, 3, &
          & 8, 12, &
          & 15, 14, &
          & 9, 5, &
          & 6, 7, 11, 10 &
          & ]
  CASE( 4 )
    Map = [ 1, 5, 25, 21, &
          & 2, 3, 4, 10, 15, 20, 24, 23, 22, &
          & 16, 11, 6, 7, 9, 19, 17, 8, 14, 18, 12, 13]
  CASE( 5 )
    Map = [ 1, 6, 36, 31, &
          & 2, 3, 4, 5, &
          & 12, 18, 24, 30, &
          & 35, 34, 33, 32, &
          & 25, 19, 13, 7, &
          & 8, 11, 29, 26, &
          & 9, 10, &
          & 17, 23, &
          & 28, 27, &
          & 20, 14, &
          & 15, 16, 22, 21]
  CASE( 6 )
    Map = [ 1, 7, 49, 43, &
          & 2, 3, 4, 5, 6, &
          & 14, 21, 28, 35, 42, &
          & 48, 47, 46, 45, 44, &
          & 36, 29, 22, 15, 8, &
          & 9, 13, 41, 37, &
          & 10, 11, 12, &
          & 20, 27, 34, &
          & 40, 39, 38, &
          & 30, 23, 16, &
          & 17, 19, 33, 31, &
          & 18, 26, 32, 24, 25]
  CASE( 7 )
    Map = [ 1, 8, 64, 57, &
          & 2, 3, 4, 5, 6, 7, &
          & 16, 24, 32, 40, 48, 56, &
          & 63, 62, 61, 60, 59, 58, &
          & 49, 41, 33, 25, 17, 9, &
          & 10, 15, 55, 50, &
          & 11, 12, 13, 14, &
          & 23, 31, 39, 47, &
          & 54, 53, 52, 51, &
          & 42, 34, 26, 18, &
          & 19, 22, 46, 43, &
          & 20, 21, &
          & 30, 38, &
          & 45, 44, &
          & 35, 27, &
          & 28, 29, 37, 36]
  END SELECT

  DO i = 1, SIZE( Map )
    NodeCoord( :, i ) = Nodes( :, Map( i ) )
  END DO

  DEALLOCATE( Map, Nodes, Pt )

END PROCEDURE EquidistanceLIP_Quadrangle

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Quadrangle

END PROCEDURE LagrangeElement_Quadrangle

!----------------------------------------------------------------------------
!                                                            LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Tetrahedron

  SELECT CASE ( Order )
    CASE( 1 )
    !tetra4
    NodeCoord = reshape( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.0, 0.0, 1.0 ], [3, 4])

    CASE( 2 )
    ! tetra10
    NodeCoord = reshape( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.0, 0.0, 1.0, &
      & 0.5, 0.0, 0.0, &
      & 0.5, 0.5, 0.0, &
      & 0.0, 0.5, 0.0, &
      & 0.0, 0.0, 0.5, &
      & 0.0, 0.5, 0.5, &
      & 0.5, 0.0, 0.5 ], [3, 10])

    CASE( 3 )
    !tetra20
    NodeCoord = reshape( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.0, 0.0, 1.0, &
      & 0.33333333333333333333, 0.0, 0.0, &
      & 0.66666666666666666667, 0.0, 0.0, &
      & 0.66666666666666666667, 0.33333333333333333333, 0.0, &
      & 0.33333333333333333333, 0.66666666666666666667, 0.0, &
      & 0.0, 0.66666666666666666667, 0.0, &
      & 0.0, 0.33333333333333333333, 0.0, &
      & 0.0, 0.0, 0.66666666666666666667, &
      & 0.0, 0.0, 0.33333333333333333333, &
      & 0.0, 0.33333333333333333333, 0.66666666666666666667, &
      & 0.0, 0.66666666666666666667, 0.33333333333333333333, &
      & 0.33333333333333333333, 0.0, 0.66666666666666666667, &
      & 0.66666666666666666667, 0.0, 0.33333333333333333333, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.0, &
      & 0.33333333333333333333, 0.0, 0.33333333333333333333, &
      & 0.0, 0.33333333333333333333, 0.33333333333333333333, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.33333333333333333333], [3,20])

    CASE( 4 )
    !tetra35
    NodeCoord = reshape( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.0, 0.0, 1.0, &
      & 0.25, 0.0, 0.0, &
      & 0.5, 0.0, 0.0, &
      & 0.75, 0.0, 0.0, &
      & 0.75, 0.25, 0.0, &
      & 0.5, 0.5, 0.0, &
      & 0.25, 0.75, 0.0, &
      & 0.0, 0.75, 0.0, &
      & 0.0, 0.5, 0.0, &
      & 0.0, 0.25, 0.0, &
      & 0.0, 0.0, 0.75, &
      & 0.0, 0.0, 0.5, &
      & 0.0, 0.0, 0.25, &
      & 0.0, 0.25, 0.75, &
      & 0.0, 0.5, 0.5, &
      & 0.0, 0.75, 0.25, &
      & 0.25, 0.0, 0.75, &
      & 0.5, 0.0, 0.5, &
      & 0.75, 0.0, 0.25, &
      & 0.25, 0.25, 0.0, &
      & 0.25, 0.5, 0.0, &
      & 0.5, 0.25, 0.0, &
      & 0.25, 0.0, 0.25, &
      & 0.5, 0.0, 0.25, &
      & 0.25, 0.0, 0.5, &
      & 0.0, 0.25, 0.25, &
      & 0.0, 0.25, 0.5, &
      & 0.0, 0.5, 0.25, &
      & 0.25, 0.25, 0.5, &
      & 0.5, 0.25, 0.25, &
      & 0.25, 0.5, 0.25, &
      & 0.25, 0.25, 0.25 ], [3, 35])

    CASE( 5 )
    !tetra56
    NodeCoord = reshape( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.0, 0.0, 1.0, &
      & 0.2, 0.0, 0.0, &
      & 0.4, 0.0, 0.0, &
      & 0.6, 0.0, 0.0, &
      & 0.8, 0.0, 0.0, &
      & 0.8, 0.2, 0.0, &
      & 0.6, 0.4, 0.0, &
      & 0.4, 0.6, 0.0, &
      & 0.2, 0.8, 0.0, &
      & 0.0, 0.8, 0.0, &
      & 0.0, 0.6, 0.0, &
      & 0.0, 0.4, 0.0, &
      & 0.0, 0.2, 0.0, &
      & 0.0, 0.0, 0.8, &
      & 0.0, 0.0, 0.6, &
      & 0.0, 0.0, 0.4, &
      & 0.0, 0.0, 0.2, &
      & 0.0, 0.2, 0.8, &
      & 0.0, 0.4, 0.6, &
      & 0.0, 0.6, 0.4, &
      & 0.0, 0.8, 0.2, &
      & 0.2, 0.0, 0.8, &
      & 0.4, 0.0, 0.6, &
      & 0.6, 0.0, 0.4, &
      & 0.8, 0.0, 0.2, &
      & 0.2, 0.2, 0.0, &
      & 0.2, 0.6, 0.0, &
      & 0.6, 0.2, 0.0, &
      & 0.2, 0.4, 0.0, &
      & 0.4, 0.4, 0.0, &
      & 0.4, 0.2, 0.0, &
      & 0.2, 0.0, 0.2, &
      & 0.6, 0.0, 0.2, &
      & 0.2, 0.0, 0.6, &
      & 0.4, 0.0, 0.2, &
      & 0.4, 0.0, 0.4, &
      & 0.2, 0.0, 0.4, &
      & 0.0, 0.2, 0.2, &
      & 0.0, 0.2, 0.6, &
      & 0.0, 0.6, 0.2, &
      & 0.0, 0.2, 0.4, &
      & 0.0, 0.4, 0.4, &
      & 0.0, 0.4, 0.2, &
      & 0.2, 0.2, 0.6, &
      & 0.6, 0.2, 0.2, &
      & 0.2, 0.6, 0.2, &
      & 0.4, 0.2, 0.4, &
      & 0.4, 0.4, 0.2, &
      & 0.2, 0.4, 0.4, &
      & 0.2, 0.2, 0.2, &
      & 0.4, 0.2, 0.2, &
      & 0.2, 0.4, 0.2, &
      & 0.2, 0.2, 0.4 ], [3, 56])

    CASE( 6 )
    NodeCoord = reshape( [ &
      & 0.0, 0.0, 0.0, &
      & 1.0, 0.0, 0.0, &
      & 0.0, 1.0, 0.0, &
      & 0.0, 0.0, 1.0, &
      & 0.16666666666666666667, 0.0, 0.0, &
      & 0.33333333333333333333, 0.0, 0.0, &
      & 0.5, 0.0, 0.0, &
      & 0.66666666666666666667, 0.0, 0.0, &
      & 0.83333333333333333333, 0.0, 0.0, &
      & 0.83333333333333333333, 0.16666666666666666667, 0.0, &
      & 0.66666666666666666667, 0.33333333333333333333, 0.0, &
      & 0.5, 0.5, 0.0, &
      & 0.33333333333333333333, 0.66666666666666666667, 0.0, &
      & 0.16666666666666666667, 0.83333333333333333333, 0.0, &
      & 0.0, 0.83333333333333333333, 0.0, &
      & 0.0, 0.66666666666666666667, 0.0, &
      & 0.0, 0.5, 0.0, &
      & 0.0, 0.33333333333333333333, 0.0, &
      & 0.0, 0.16666666666666666667, 0.0, &
      & 0.0, 0.0, 0.83333333333333333333, &
      & 0.0, 0.0, 0.66666666666666666667, &
      & 0.0, 0.0, 0.5, &
      & 0.0, 0.0, 0.33333333333333333333, &
      & 0.0, 0.0, 0.16666666666666666667, &
      & 0.0, 0.16666666666666666667, 0.83333333333333333333, &
      & 0.0, 0.33333333333333333333, 0.66666666666666666667, &
      & 0.0, 0.5, 0.5, &
      & 0.0, 0.66666666666666666667, 0.33333333333333333333, &
      & 0.0, 0.83333333333333333333, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.0, 0.83333333333333333333, &
      & 0.33333333333333333333, 0.0, 0.66666666666666666667, &
      & 0.5, 0.0, 0.5, &
      & 0.66666666666666666667, 0.0, 0.33333333333333333333, &
      & 0.83333333333333333333, 0.0, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.16666666666666666667, 0.0, &
      & 0.16666666666666666667, 0.66666666666666666667, 0.0, &
      & 0.66666666666666666667, 0.16666666666666666667, 0.0, &
      & 0.16666666666666666667, 0.33333333333333333333, 0.0, &
      & 0.16666666666666666667, 0.5, 0.0, &
      & 0.33333333333333333333, 0.5, 0.0, &
      & 0.5, 0.33333333333333333333, 0.0, &
      & 0.5, 0.16666666666666666667, 0.0, &
      & 0.33333333333333333333, 0.16666666666666666667, 0.0, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.0, &
      & 0.16666666666666666667, 0.0, 0.16666666666666666667, &
      & 0.66666666666666666667, 0.0, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.0, 0.66666666666666666667, &
      & 0.33333333333333333333, 0.0, 0.16666666666666666667, &
      & 0.5, 0.0, 0.16666666666666666667, &
      & 0.5, 0.0, 0.33333333333333333333, &
      & 0.33333333333333333333, 0.0, 0.5, &
      & 0.16666666666666666667, 0.0, 0.5, &
      & 0.16666666666666666667, 0.0, 0.33333333333333333333, &
      & 0.33333333333333333333, 0.0, 0.33333333333333333333, &
      & 0.0, 0.16666666666666666667, 0.16666666666666666667, &
      & 0.0, 0.16666666666666666667, 0.66666666666666666667, &
      & 0.0, 0.66666666666666666667, 0.16666666666666666667, &
      & 0.0, 0.16666666666666666667, 0.33333333333333333333, &
      & 0.0, 0.16666666666666666667, 0.5, &
      & 0.0, 0.33333333333333333333, 0.5, &
      & 0.0, 0.5, 0.33333333333333333333, &
      & 0.0, 0.5, 0.16666666666666666667, &
      & 0.0, 0.33333333333333333333, 0.16666666666666666667, &
      & 0.0, 0.33333333333333333333, 0.33333333333333333333, &
      & 0.16666666666666666667, 0.16666666666666666667, 0.66666666666666666667, &
      & 0.66666666666666666667, 0.16666666666666666667, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.66666666666666666667, 0.16666666666666666667, &
      & 0.33333333333333333333, 0.16666666666666666667, 0.5, &
      & 0.5, 0.16666666666666666667, 0.33333333333333333333, &
      & 0.5, 0.33333333333333333333, 0.16666666666666666667, &
      & 0.33333333333333333333, 0.5, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.5, 0.33333333333333333333, &
      & 0.16666666666666666667, 0.33333333333333333333, 0.5, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.33333333333333333333, &
      & 0.16666666666666666667, 0.16666666666666666667, 0.16666666666666666667, &
      & 0.5, 0.16666666666666666667, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.5, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.16666666666666666667, 0.5, &
      & 0.33333333333333333333, 0.16666666666666666667, 0.16666666666666666667, &
      & 0.33333333333333333333, 0.33333333333333333333, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.33333333333333333333, 0.16666666666666666667, &
      & 0.16666666666666666667, 0.16666666666666666667, 0.33333333333333333333, &
      & 0.16666666666666666667, 0.33333333333333333333, 0.33333333333333333333, &
      & 0.33333333333333333333, 0.16666666666666666667, 0.33333333333333333333], [3, 84])
  END SELECT

END PROCEDURE EquidistanceLIP_Tetrahedron

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Tetrahedron

END PROCEDURE LagrangeElement_Tetrahedron

!----------------------------------------------------------------------------
!                                                            LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Prism

END PROCEDURE EquidistanceLIP_Prism

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Prism

END PROCEDURE LagrangeElement_Prism

!----------------------------------------------------------------------------
!                                                            LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Pyramid

END PROCEDURE EquidistanceLIP_Pyramid

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Pyramid

END PROCEDURE LagrangeElement_Pyramid

!----------------------------------------------------------------------------
!                                                            LagrangePoints
!----------------------------------------------------------------------------

MODULE PROCEDURE EquidistanceLIP_Hexahedron

END PROCEDURE EquidistanceLIP_Hexahedron

!----------------------------------------------------------------------------
!                                                             LagrangeElement
!----------------------------------------------------------------------------

MODULE PROCEDURE LagrangeElement_Hexahedron

END PROCEDURE LagrangeElement_Hexahedron

END SUBMODULE Lagrange